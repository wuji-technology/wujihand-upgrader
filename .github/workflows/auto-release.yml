name: Auto Release from CHANGELOG

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse CHANGELOG and Create Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // 检查 CHANGELOG.md 是否存在
            if (!fs.existsSync('CHANGELOG.md')) {
              core.setFailed('CHANGELOG.md not found');
              return;
            }
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');

            // 从 tag 提取版本号
            const tag = context.ref.replace('refs/tags/', '');
            const version = tag.replace(/^v/, '');
            console.log(`Processing tag: ${tag}, version: ${version}`);

            // 分类映射
            const categoryMap = {
              'Added': 'New Features', '新增': 'New Features',
              'Changed': 'Improvements', '变更': 'Improvements',
              'Fixed': 'Bug Fixes', '修复': 'Bug Fixes'
            };
            const cautionCategories = {
              'Removed': 'Removed', '移除': 'Removed',
              'Deprecated': 'Deprecated', '废弃': 'Deprecated',
              'Security': 'Security', '安全': 'Security'
            };

            // 解析版本内容
            function parseContent(content) {
              const sections = { 'New Features': [], 'Improvements': [], 'Bug Fixes': [] };
              const cautionItems = [];
              let currentCategory = '';
              let currentCautionPrefix = '';

              for (const line of content.trim().split('\n')) {
                const catMatch = line.match(/^### (.+)/);
                if (catMatch) {
                  const cat = catMatch[1].trim();
                  if (categoryMap[cat]) {
                    currentCategory = categoryMap[cat];
                    currentCautionPrefix = '';
                  } else if (cautionCategories[cat]) {
                    currentCategory = 'CAUTION';
                    currentCautionPrefix = cautionCategories[cat];
                  } else {
                    currentCategory = '';
                  }
                } else if (line.startsWith('- ')) {
                  const item = line.slice(2);
                  if (currentCategory === 'CAUTION') {
                    cautionItems.push(`**${currentCautionPrefix}**: ${item}`);
                  } else if (currentCategory && sections[currentCategory]) {
                    sections[currentCategory].push(item);
                  }
                }
              }

              let body = '';
              for (const section of ['New Features', 'Improvements', 'Bug Fixes']) {
                if (sections[section].length > 0) {
                  body += `### ${section}\n${sections[section].map(i => `- ${i}`).join('\n')}\n\n`;
                }
              }
              if (cautionItems.length > 0) {
                body += `> [!CAUTION]\n${cautionItems.map(i => `> - ${i}`).join('\n')}\n\n`;
              }
              return body.trim();
            }

            // 查找对应版本（转义版本号中的特殊字符，支持预发布版本如 1.0.0-rc4）
            const escapedVersion = version.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const versionRegex = new RegExp(`## \\[${escapedVersion}\\](?: - (\\d{4}-\\d{2}-\\d{2}))?\\n([\\s\\S]*?)(?=\\n## \\[|$)`);
            const match = changelog.match(versionRegex);

            if (!match) {
              core.setFailed(`Version ${version} not found in CHANGELOG.md`);
              return;
            }

            const date = match[1] || new Date().toISOString().split('T')[0];
            const content = match[2];
            let body = parseContent(content);

            // 获取所有版本用于 Full Changelog（支持预发布版本如 1.0.0-rc4）
            const allVersions = [...changelog.matchAll(/## \[(\d+\.\d+\.\d+(?:-[a-zA-Z0-9.]+)?)\]/g)].map(m => m[1]);
            const versionIndex = allVersions.indexOf(version);
            const prevVersion = allVersions[versionIndex + 1];
            if (prevVersion) {
              body += `\n\n---\n\n**Full Changelog**: [v${prevVersion}...${tag}](https://github.com/${context.repo.owner}/${context.repo.repo}/compare/v${prevVersion}...${tag})`;
            }

            // Upsert: 检查 release 是否存在，存在则更新，不存在则创建
            const releaseBody = `## ${tag} (${date})\n\n${body}`;
            let existingRelease;
            try {
              existingRelease = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
            } catch (e) {
              // 只有 404 表示 release 不存在，其他错误应该抛出
              if (e.status !== 404) {
                throw e;
              }
            }

            if (existingRelease) {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: existingRelease.data.id,
                tag_name: tag,
                name: tag,
                body: releaseBody,
                prerelease: true,
                make_latest: 'false'
              });
              console.log(`Updated pre-release: ${tag}`);
            } else {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: tag,
                body: releaseBody,
                prerelease: true,
                make_latest: 'false'
              });
              console.log(`Created pre-release: ${tag}`);
            }
